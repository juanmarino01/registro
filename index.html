<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Salud</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .btn-primary {
            background-color: #4a6fa5;
            border-color: #4a6fa5;
        }
        .btn-success {
            background-color: #6bbf59;
            border-color: #6bbf59;
        }
        .table th {
            background-color: #4a6fa5;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Control de Salud Personal</h1>
        
        <!-- Formulario de registro -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Nuevo Registro</h5>
            </div>
            <div class="card-body">
                <form id="healthForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">Fecha</label>
                            <input type="date" class="form-control" id="fecha" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="hora" class="form-label">Hora</label>
                            <input type="time" class="form-control" id="hora" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="temperatura" class="form-label">Temperatura (°C)</label>
                            <input type="number" step="0.1" class="form-control" id="temperatura">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="glucosa" class="form-label">Glucosa (mg/dL)</label>
                            <input type="number" class="form-control" id="glucosa">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="presion" class="form-label">Presión Arterial</label>
                            <input type="text" class="form-control" id="presion" placeholder="Ej: 120/80">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="saturacion" class="form-label">Saturación (%)</label>
                            <input type="number" class="form-control" id="saturacion" min="0" max="100">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="insulinaNormal" class="form-label">Insulina Normal (UI)</label>
                            <input type="number" step="0.1" class="form-control" id="insulinaNormal">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="insulinaEscape" class="form-label">Insulina Escape (UI)</label>
                            <input type="number" step="0.1" class="form-control" id="insulinaEscape">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="observacion" class="form-label">Observación</label>
                        <textarea class="form-control" id="observacion" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar Registro</button>
                </form>
            </div>
        </div>

        <!-- Controles de la aplicación -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button id="generatePDF" class="btn btn-primary w-100 mb-2">Generar PDF</button>
                    </div>
                    <div class="col-md-6">
                        <button id="refreshData" class="btn btn-secondary w-100 mb-2">Actualizar Datos</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Gráficos de Control</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="healthChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabla de registros -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Historial de Registros</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Temperatura</th>
                                <th>Glucosa</th>
                                <th>Presión</th>
                                <th>Saturación</th>
                                <th>Insulina Normal</th>
                                <th>Insulina Escape</th>
                                <th>Observación</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable">
                            <!-- Los registros se cargarán aquí dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            // Reemplaza con tu configuración de Firebase
            apiKey: "AIzaSyBTvjv6H6oKhw-WdvMCIk0AhaYUuUTwx-E",
            authDomain: "control-salud-personal.firebaseapp.com",
            projectId: "control-salud-personal",
            storageBucket: "control-salud-personal.firebasestorage.app",
            messagingSenderId: "709582237955",
            appId: "1:709582237955:web:f59af7bab5573f8de9f936",
            measurementId: "G-2VN6924RMX"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        //const app = initializeApp(firebaseConfig);
        //const analytics = getAnalytics(app);

        // Variables globales
        let healthRecords = [];
        let healthChart;

        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Establecer fecha y hora actuales por defecto
            const now = new Date();
            document.getElementById('fecha').value = now.toISOString().split('T')[0];
            document.getElementById('hora').value = now.toTimeString().substring(0, 5);
            
            // Cargar registros existentes
            loadRecords();
            
            // Configurar eventos
            document.getElementById('healthForm').addEventListener('submit', saveRecord);
            document.getElementById('refreshData').addEventListener('click', loadRecords);
            document.getElementById('generatePDF').addEventListener('click', generatePDF);
        });

        // Guardar un nuevo registro
        async function saveRecord(e) {
            e.preventDefault();
            
            const record = {
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                temperatura: parseFloat(document.getElementById('temperatura').value) || null,
                glucosa: parseInt(document.getElementById('glucosa').value) || null,
                presion: document.getElementById('presion').value || '',
                saturacion: parseInt(document.getElementById('saturacion').value) || null,
                insulinaNormal: parseFloat(document.getElementById('insulinaNormal').value) || null,
                insulinaEscape: parseFloat(document.getElementById('insulinaEscape').value) || null,
                observacion: document.getElementById('observacion').value || '',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('healthRecords').add(record);
                alert('Registro guardado exitosamente');
                document.getElementById('healthForm').reset();
                
                // Restablecer fecha y hora actuales
                const now = new Date();
                document.getElementById('fecha').value = now.toISOString().split('T')[0];
                document.getElementById('hora').value = now.toTimeString().substring(0, 5);
                
                // Recargar registros
                loadRecords();
            } catch (error) {
                console.error('Error al guardar el registro: ', error);
                alert('Error al guardar el registro');
            }
        }

        // Cargar registros desde Firebase
        async function loadRecords() {
            try {
                const snapshot = await db.collection('healthRecords')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                healthRecords = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    healthRecords.push(data);
                });
                
                updateTable();
                updateChart();
            } catch (error) {
                console.error('Error al cargar los registros: ', error);
            }
        }

        // Actualizar la tabla con los registros
        function updateTable() {
            const tableBody = document.getElementById('recordsTable');
            tableBody.innerHTML = '';
            
            healthRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.fecha}</td>
                    <td>${record.hora}</td>
                    <td>${record.temperatura || '-'}</td>
                    <td>${record.glucosa || '-'}</td>
                    <td>${record.presion || '-'}</td>
                    <td>${record.saturacion || '-'}</td>
                    <td>${record.insulinaNormal || '-'}</td>
                    <td>${record.insulinaEscape || '-'}</td>
                    <td>${record.observacion || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Actualizar el gráfico
        function updateChart() {
            const ctx = document.getElementById('healthChart').getContext('2d');
            
            // Si ya existe un gráfico, destruirlo
            if (healthChart) {
                healthChart.destroy();
            }
            
            // Preparar datos para el gráfico
            const labels = healthRecords.map(record => `${record.fecha} ${record.hora}`).reverse();
            const glucosaData = healthRecords.map(record => record.glucosa).reverse();
            const temperaturaData = healthRecords.map(record => record.temperatura).reverse();
            const saturacionData = healthRecords.map(record => record.saturacion).reverse();
            
            // Crear nuevo gráfico
            healthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Glucosa (mg/dL)',
                            data: glucosaData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Temperatura (°C)',
                            data: temperaturaData,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        },
                        {
                            label: 'Saturación (%)',
                            data: saturacionData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            yAxisID: 'y2',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Fecha y Hora'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Glucosa (mg/dL)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Temperatura (°C)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Saturación (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            // Ajustar la posición para no superponerse con y1
                            offset: true
                        }
                    }
                }
            });
        }

        // Generar PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text('Reporte de Control de Salud', 20, 20);
            
            // Fecha de generación
            doc.setFontSize(12);
            doc.text(`Generado el: ${new Date().toLocaleDateString()}`, 20, 30);
            
            // Tabla de registros
            let yPosition = 50;
            doc.setFontSize(10);
            
            // Encabezados de la tabla
            doc.text('Fecha', 20, yPosition);
            doc.text('Hora', 40, yPosition);
            doc.text('Temp.', 60, yPosition);
            doc.text('Glucosa', 75, yPosition);
            doc.text('Presión', 95, yPosition);
            doc.text('Sat.', 115, yPosition);
            doc.text('Ins. N.', 130, yPosition);
            doc.text('Ins. E.', 150, yPosition);
            
            yPosition += 10;
            
            // Datos de la tabla
            healthRecords.slice(0, 20).forEach(record => { // Limitar a 20 registros para evitar PDF demasiado largo
                doc.text(record.fecha, 20, yPosition);
                doc.text(record.hora, 40, yPosition);
                doc.text(record.temperatura ? record.temperatura.toString() : '-', 60, yPosition);
                doc.text(record.glucosa ? record.glucosa.toString() : '-', 75, yPosition);
                doc.text(record.presion || '-', 95, yPosition);
                doc.text(record.saturacion ? record.saturacion.toString() : '-', 115, yPosition);
                doc.text(record.insulinaNormal ? record.insulinaNormal.toString() : '-', 130, yPosition);
                doc.text(record.insulinaEscape ? record.insulinaEscape.toString() : '-', 150, yPosition);
                
                yPosition += 10;
                
                // Nueva página si es necesario
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
            });
            
            // Guardar PDF
            doc.save('reporte_salud.pdf');
        }
    </script>
</body>
</html>
